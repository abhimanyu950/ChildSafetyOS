rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ===================================
    // CHILDSAFETYOS - PRODUCTION RULES
    // Secure but functional
    // ===================================
    
    // Validate device ID format (alphanumeric, 8-64 chars)
    function isValidDeviceId(deviceId) {
      return deviceId.size() >= 8 && deviceId.size() <= 64;
    }
    
    // Validate event type
    function isValidEventType(eventType) {
      return eventType in [
        'IMAGE_BLOCKED', 'VIDEO_BLOCKED', 'URL_BLOCKED', 
        'SEARCH_BLOCKED', 'PAGE_BLOCKED', 'APP_LOCKED',
        'DOMAIN_BLOCKED', 'VPN_STARTED', 'VPN_STOPPED',
        'PROTECTION_ENABLED', 'PROTECTION_DISABLED'
      ];
    }
    
    // Validate severity
    function isValidSeverity(severity) {
      return severity in ['LOW', 'MEDIUM', 'HIGH', 'CRITICAL'];
    }
    
    // ===================================
    // DEVICE DOCUMENTS
    // ===================================
    match /devices/{deviceId} {
      // READ: Any valid device ID can read its own data
      allow read: if isValidDeviceId(deviceId);
      
      // CREATE: Allow device registration
      allow create: if isValidDeviceId(deviceId) &&
                       request.resource.data.keys().hasAny(['deviceName', 'deviceId']);
      
      // UPDATE: Allow status updates
      allow update: if isValidDeviceId(deviceId);
      
      // DELETE: Not allowed from client
      allow delete: if false;
      
      // ===================================
      // EVENTS SUBCOLLECTION
      // ===================================
      match /events/{eventId} {
        // READ: Allow reading events
        allow read: if isValidDeviceId(deviceId);
        
        // CREATE: Allow with validation
        allow create: if isValidDeviceId(deviceId) &&
                         request.resource.data.eventType is string &&
                         isValidEventType(request.resource.data.eventType);
        
        // UPDATE/DELETE: Events are immutable
        allow update, delete: if false;
      }
      
      // ===================================
      // DAILY STATS SUBCOLLECTION
      // ===================================
      match /daily_stats/{date} {
        allow read: if isValidDeviceId(deviceId);
        allow write: if isValidDeviceId(deviceId);
      }
      
      // ===================================
      // ALERTS SUBCOLLECTION
      // ===================================
      match /alerts/{alertId} {
        allow read: if isValidDeviceId(deviceId);
        
        // CREATE: Validate alert structure
        allow create: if isValidDeviceId(deviceId) &&
                         request.resource.data.keys().hasAny(['alertType', 'message']);
        
        // UPDATE: Allow acknowledging alerts
        allow update: if isValidDeviceId(deviceId);
        
        allow delete: if false;
      }
      
      // ===================================
      // SESSIONS SUBCOLLECTION
      // ===================================
      match /sessions/{sessionId} {
        allow read, write: if isValidDeviceId(deviceId);
      }
    }
    
    // ===================================
    // GLOBAL COLLECTIONS (Read-only)
    // ===================================
    match /blocklist/{document=**} {
      allow read: if true;
      allow write: if false;
    }
    
    match /config/{document=**} {
      allow read: if true;
      allow write: if false;
  }
}
